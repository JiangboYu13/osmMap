var nodes = [['31.41809682', '121.20839305'],
['31.41811389', '121.20837813'],
['31.41813389', '121.20836064'],
['31.418183', '121.20831771'],
['31.4181896', '121.20831194'],
['31.41820611', '121.20829751'],
['31.41822257', '121.20828311'],
['31.41823914', '121.20826863'],
['31.41824576', '121.20826284'],
['31.41826228', '121.2082484'],
['31.41827875', '121.20823401'],
['31.41829536', '121.20821948'],
['31.41830232', '121.2082134'],
['31.41831888', '121.20819892'],
['31.41833554', '121.20818436'],
['31.41835186', '121.20817009'],
['31.41816652', '121.20833212'],
['31.41814993', '121.20834662'],
['31.41835928', '121.20816361'],
['31.41837647', '121.20814858'],
['31.41839386', '121.20813338'],
['31.41841097', '121.20811842'],
['31.41807938', '121.2084083'],
['31.41809482', '121.20843256'],
['31.41810207', '121.20844395'],
['31.41810822', '121.20828326'],
['31.4181336', '121.20832313'],
['31.41814146', '121.20825421'],
['31.41812497', '121.20826862'],
['31.41815036', '121.20830848'],
['31.41816684', '121.20829407'],
['31.41814635', '121.20824569'],
['31.41817346', '121.20828828'],
['31.41816285', '121.20823126'],
['31.41818996', '121.20827385'],
['31.418196', '121.20820228'],
['31.41817944', '121.20821676'],
['31.41820655', '121.20825935'],
['31.41822311', '121.20824487'],
['31.41820254', '121.20819654'],
['31.41822966', '121.20823915'],
['31.41821908', '121.20818208'],
['31.4182462', '121.20822469'],
['31.41825233', '121.20815301'],
['31.41823559', '121.20816765'],
['31.41826271', '121.20821025'],
['31.41827946', '121.20819561'],
['31.41825973', '121.2081465'],
['31.41828688', '121.20818913'],
['31.41827632', '121.208132'],
['31.41830346', '121.20817463'],
['31.41830928', '121.20810318'],
['31.41829293', '121.20811747'],
['31.41832008', '121.2081601'],
['31.41833642', '121.20814582'],
['31.41831752', '121.20809818'],
['31.41834377', '121.2081394'],
['31.41833474', '121.20808314'],
['31.41836097', '121.20812435'],
['31.41836928', '121.20805294'],
['31.41835207', '121.20806798'],
['31.41837831', '121.2081092'],
['31.41839552', '121.20809415'],
['31.41809481', '121.20843255'],
['31.41812134', '121.20847422'],
['31.41811091', '121.20841848'],
['31.41813744', '121.20846014'],
['31.41812716', '121.20840428'],
['31.41815368', '121.20844594'],
['31.41816978', '121.20843187'],
['31.41814326', '121.2083902'],
['31.41814977', '121.20838451'],
['31.41817631', '121.20842619'],
['31.41816626', '121.20837009'],
['31.4181928', '121.20841177'],
['31.41818267', '121.20835574'],
['31.41820921', '121.20839742'],
['31.41822569', '121.20838301'],
['31.41819916', '121.20834134'],
['31.41820573', '121.20833559'],
['31.41823228', '121.20837728'],
['31.41822224', '121.20832115'],
['31.41824879', '121.20836285'],
['31.41823858', '121.20830687'],
['31.41826513', '121.20834856'],
['31.41828171', '121.20833407'],
['31.41825517', '121.20829237'],
['31.41826185', '121.20828653'],
['31.41828833', '121.20832811'],
['31.41827835', '121.2082721'],
['31.41830483', '121.20831369'],
['31.41829477', '121.20825775'],
['31.41832124', '121.20829934'],
['31.41833773', '121.20828492'],
['31.41831125', '121.20824334'],
['31.41831776', '121.20823765'],
['31.4183443', '121.20827934'],
['31.41833429', '121.2082232'],
['31.41836083', '121.20826489'],
['31.41835099', '121.20820859'],
['31.41837753', '121.20825028'],
['31.41839383', '121.20823604'],
['31.41836729', '121.20819435'],
['31.41837477', '121.2081878'],
['31.41840125', '121.20822939'],
['31.41839195', '121.20817279'],
['31.41841842', '121.20821438'],
['31.41842641', '121.20814267'],
['31.41840939', '121.20815754'],
['31.41843587', '121.20819913'],
['31.41845288', '121.20818425'],
['31.4241637', '121.2052245'],
['31.4189137', '121.2101584'],
['31.4204098', '121.2081881'],
['31.421987', '121.2068113'],
['31.4233321', '121.217063'],
['31.4104347', '121.2160771'],
['31.411497', '121.2152225'],
['31.4126693', '121.2144284'],
['31.4135929', '121.213948'],
['31.4145454', '121.2134598'],
['31.4154381', '121.2129928'],
['31.4165515', '121.2123685'],
['31.4176271', '121.2115755'],
['31.4197641', '121.2061073'],
['31.4173943', '121.2008778'],
['31.4161992', '121.2126047'],
['31.4092923', '121.2172731'],
['31.412331', '121.1936788'],
['31.4112626', '121.1917468'],
['31.4192552', '121.2105893'],
['31.4150305', '121.1985489'],
['31.4196222', '121.2051578'],
['31.4205906', '121.2080125'],
['31.4097021', '121.2167962'],
['31.4213001', '121.207372'],
['31.4181664', '121.2016978'],
['31.4155432', '121.1992409'],
['31.4203404', '121.2075018'],
['31.4188959', '121.2028466'],
['31.4182405', '121.2109712'],
['31.4199625', '121.2066928'],
['31.4184823', '121.2021323'],
['31.4192559', '121.203688'],
['31.416172', '121.1999069'],
['31.419494', '121.2045141'],
['31.4137227', '121.1961893'],
['31.4242292', '121.2051659'],
['31.4181319', '121.2095933'],
['31.4162795', '121.2067161'],
['31.4138844', '121.2029808'],
['31.4121526', '121.2003055'],
['31.4116012', '121.199306'],
['31.4148504', '121.1982239'],
['31.4147837', '121.1981036'],
['31.4164828', '121.2124146'],
['31.419936', '121.2116414'],
['31.4226181', '121.2059298'],
['31.4214356', '121.2068699'],
['31.4212296', '121.2069021'],
['31.4200943', '121.2078999'],
['31.4199203', '121.2079696'],
['31.4197052', '121.2081413'],
['31.4191283', '121.2088387'],
['31.4181807', '121.2099974'],
['31.417668', '121.2105767'],
['31.4170866', '121.2111078'],
['31.4158688', '121.2119769'],
['31.415411', '121.2122397'],
['31.4145961', '121.2125294'],
['31.4140788', '121.2127279'],
['31.4195497', '121.2083293'],
['31.4190734', '121.2075834'],
['31.4168897', '121.2037317'],
['31.4146694', '121.1998479'],
['31.4138087', '121.1984049'],
['31.419414', '121.2042364'],
['31.4169715', '121.200542'],
['31.4179261', '121.2097915'],
['31.4175713', '121.2093421'],
['31.415433', '121.2059487'],
['31.4122206', '121.2009823'],
['31.4114918', '121.1996227'],
['31.4103218', '121.2007463'],
['31.4075504', '121.196117'],
['31.407045', '121.1952179'],
['31.4117833', '121.2001665'],
['31.4142332', '121.2126686'],
['31.4141659', '121.2083893'],
['31.4122091', '121.2098899'],
['31.4143331', '121.2135767'],
['31.4102501', '121.21625'],
['31.4200243', '121.2195208'],
['31.41857', '121.2122897'],
['31.4192223', '121.2134768'],
['31.4194443', '121.2142248'],
['31.4199023', '121.2149241'],
['31.4204296', '121.2146639'],
['31.4210541', '121.2162088'],
['31.4214426', '121.2159161'],
['31.4217341', '121.2159649'],
['31.4224695', '121.2173146'],
['31.4226459', '121.2176735'],
['31.422573', '121.2178676'],
['31.4217184', '121.2185198'],
['31.4209764', '121.2188769'],
['31.4203668', '121.2190787'],
['31.4233061', '121.2058497'],
['31.4217777', '121.2069821'],
['31.4122247', '121.2004169']];
var parking_corners = [[110, 109, 108, 107],
[109, 106, 105, 108],
[106, 104, 103, 105],
[101, 100, 99, 102],
[100, 98, 97, 99],
[98, 96, 95, 97],
[93, 92, 91, 94],
[92, 90, 89, 91],
[90, 88, 87, 89],
[85, 84, 83, 86],
[84, 82, 81, 83],
[82, 80, 79, 81],
[77, 76, 75, 78],
[76, 74, 73, 75],
[74, 72, 71, 73],
[69, 68, 67, 70],
[68, 66, 65, 67],
[66, 64, 63, 65],
[62, 61, 60, 59],
[61, 58, 57, 60],
[58, 56, 55, 57],
[54, 53, 52, 51],
[53, 50, 49, 52],
[50, 48, 47, 49],
[46, 45, 44, 43],
[45, 42, 41, 44],
[42, 40, 39, 41],
[38, 37, 36, 35],
[37, 34, 33, 36],
[34, 32, 31, 33],
[30, 29, 28, 27],
[29, 26, 25, 28]];
var parking_ids;
var map;
var cur_location_marker;
var cur_location = ['31.41824576', '121.20826284'];
var cur_location_icon;
var path;

$(document).ready(function(){
    map = L.map('map',{zoomControl:false}).setView(cur_location, 22);
    L.tileLayer('http://127.0.0.1/hot/{z}/{x}/{y}.png', {
        maxZoom:25,
        minZoom:18,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    L.polygon([ [31.4177577, 121.2087128],
        [31.4177375, 121.208683 ],
        [31.4188981, 121.207668],
        [31.4189176 , 121.20770025]], 
        {color: 'black',weight:1,Opacity:0.5, fill: true, fillColor:'white',fillOpacity:1 }).addTo(map);
    parking_ids = [];
    for (parking_corner of parking_corners)
    {
        var imageUrl = 'img/no_parking.jpg',
        overlay = L.imageOverlay.rotated(imageUrl, nodes[parking_corner[0]], nodes[parking_corner[1]], nodes[parking_corner[3]], {
            opacity: 0.4,
            interactive: true,
        }).addTo(map);
        parking_ids.push(overlay)
    }
    var latlngs = [
    ['31.4181139', '121.2083785'],
    ['31.4183594', '121.2081635'],
    ['31.4183628', '121.2081571'],
    ['31.4183649', '121.2081465'],
    ['31.4183609', '121.2081404']];
    path = L.polyline(latlngs, {color: 'green',weight: 30, opacity: 0.5}).addTo(map);
    

    cur_location_icon = L.icon({
            iconUrl: 'img/circle_orange.png',
            iconSize:     [20, 20], // size of the icon
            iconAnchor:   [20, 15], // point of the icon which will correspond to marker's location
        });
    cur_location_marker = L.marker(cur_location, {icon: cur_location_icon}).addTo(map);


    map.on('zoomend', function () {
        currentZoom = map.getZoom();
        path.setStyle({weight: 5*Math.pow(2,Math.max(0, currentZoom-20))});
        icon = cur_location_marker.options.icon;
        icon.options.iconSize=[Math.max(currentZoom-18, 1)*4, 
                               Math.max(currentZoom-18, 1)*4];
        cur_location_marker.setIcon(icon);
    });
    
});

function onTargetClick(tag_id)
{

    document.getElementById(tag_id).style.opacity = 1;
    map.flyTo(new L.LatLng(31.41752302937,121.20643853877), 19);
}   
function onTargetRealease(tag_id)
{
    document.getElementById(tag_id).style.opacity=0.5;

}
function onParkIconClick(tag_id)
{
    document.getElementById(tag_id).style.opacity = 1;
}
function onParkIconRelease(tag_id)
{
    document.getElementById(tag_id).style.opacity=0.3;
}

setInterval(function() {
    $.get("http://127.0.0.1/cgi_bin/cgiHandler.fcgi", 
        {"reqType": "parking"},
        function(data)
        {
            if (data == "null")
                return;
            raw_data = JSON.parse(data);
            console.log(raw_data);
            uss_data = raw_data["uss"];
            pos_data = raw_data["pos"];
            if (uss_data !== undefined)
            {
                console.log(uss_data)
                for (i = 0; i < 6; i++) 
                {
                    if (uss_data[i]==true)
                        parking_ids[i].setUrl('img/parking.jpg');
                    else
                        parking_ids[i].setUrl('img/no_parking.jpg');
                }
            }
            if (pos_data !== undefined)
            {
                cur_location = [pos_data.lat, pos_data.lon];
                cur_location_marker.setLatLng(cur_location);
                //map.flyTo(cur_location);
            }

        });
}, 100);


setInterval(function(){

}, 500)